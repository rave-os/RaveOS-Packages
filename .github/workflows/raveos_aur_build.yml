name: RaveOS AUR Package Build and Publish

on:
  push:
    branches:
      - main
  workflow_dispatch: {}
  schedule:
    - cron: '0 0 * * 0' # Runs every Sunday at 00:00 UTC
  
permissions:
  contents: write

env:
  REPO_NAME: raveos-repo
  MAX_PKG_VERSIONS: 2
  BUILDER_USER: builder # New environment variable for the non-root user
  
jobs:
  build_package:
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        package_name: 
          - yaru
          - gnome-clocks-git
          
    name: Build ${{ matrix.package_name }}

    container:
      image: archlinux:latest
      # NOTE: options: --user root is removed. We start as root (default) to set up the builder.

    steps:
      - name: Setup Builder User and Install Dependencies
        run: |
          # 1. Install dependencies first, including 'sudo', which creates necessary files.
          pacman -Sy --noconfirm
          pacman -S --noconfirm base-devel git sudo cmake
          
          # 2. Ensure the /etc/sudoers.d directory exists and has correct permissions
          mkdir -p /etc/sudoers.d
          chmod 0755 /etc/sudoers.d
          
          # 3. Create a non-root user 'builder'
          useradd -m -u 1000 ${{ env.BUILDER_USER }}
          
          # 4. Grant passwordless sudo access to the builder user (now the directory exists)
          echo '${{ env.BUILDER_USER }} ALL=(ALL) NOPASSWD: ALL' > /etc/sudoers.d/builder_user
          chmod 0440 /etc/sudoers.d/builder_user

      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Create Repository Directory
        run: mkdir -p ${{ env.REPO_NAME }}
        
      - name: Import GPG Key for Signing
        env:
          GNUPGHOME: /root/.gnupg 
        run: |
          # This step must run as root/default user to ensure GPG files are placed in /root/.gnupg
          # where the next steps can access and copy them.
          echo "Setting up GNUPGHOME in $GNUPGHOME"
          mkdir -p $GNUPGHOME
          chmod 700 $GNUPGHOME
          
          echo "${{ secrets.GPG_PRIVATE_KEY }}" > private.key
          gpg --batch --pinentry-mode loopback --passphrase ${{ secrets.GPG_PASSPHRASE }} --import private.key
          
          KEYID=$(gpg --batch --list-secret-keys --keyid-format long | grep sec | head -n 1 | awk '{print $2}' | cut -d/ -f2)
          echo -e "trust\n5\ny\n" | gpg --batch --command-fd 0 --edit-key $KEYID
          
          rm private.key
          
      - name: Fetch and Build Package
        id: build
        env:
          PKG_NAME: ${{ matrix.package_name }}
          # The HOME for the shell session needs to be /root, but we run commands as 'builder'
          
        run: |
          echo "Building package: $PKG_NAME"
          
          # --- Setup for Builder User ---
          BUILD_DIR=/home/${{ env.BUILDER_USER }}/build/${{ matrix.package_name }}
          mkdir -p $BUILD_DIR
          chown -R ${{ env.BUILDER_USER }}:${{ env.BUILDER_USER }} /home/${{ env.BUILDER_USER }}

          # 1. Clone the AUR PKGBUILD AS THE BUILDER USER
          sudo -u ${{ env.BUILDER_USER }} git clone "https://aur.archlinux.org/$PKG_NAME.git" $BUILD_DIR
          
          cd $BUILD_DIR
          
          # 2. Build the package AS THE BUILDER USER
          # The makepkg command will now succeed because it is not running as root.
          sudo -u ${{ env.BUILDER_USER }} makepkg -s -f --skipchecksums --skippgpcheck --noconfirm
          
          BUILT_PKG=$(find . -maxdepth 1 -name '*.pkg.tar.zst' | head -n 1)
          if [ -z "$BUILT_PKG" ]; then
            echo "::error::Package build failed or .pkg.tar.zst file not found."
            exit 1
          fi
          
          # 3. Copy GPG files to builder's home temporarily for signing
          # Copy .gnupg from root to builder's home and set permissions
          cp -r /root/.gnupg /home/${{ env.BUILDER_USER }}/
          chown -R ${{ env.BUILDER_USER }}:${{ env.BUILDER_USER }} /home/${{ env.BUILDER_USER }}/.gnupg
          
          # 4. Sign the package AS THE BUILDER USER
          # makepkg will now find the key in the builder's home directory
          sudo -u ${{ env.BUILDER_USER }} makepkg --sign
          
          # 5. Move the built files back to the root context for publishing
          mv $BUILT_PKG /root/
          mv $BUILT_PKG.sig /root/
          
          echo "pkg_file=/root/$BUILT_PKG" >> $GITHUB_OUTPUT
          echo "pkg_dir=$PKG_NAME" >> $GITHUB_OUTPUT

      - name: Publish and Clean Repository
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          # pkg_file now includes the /root/ prefix
          PKG_FILE: ${{ steps.build.outputs.pkg_file }}
          PKG_DIR: ${{ steps.build.outputs.pkg_dir }}
          GNUPGHOME: /root/.gnupg
        run: |
          # Strip the /root/ prefix to get just the filename for repo-add
          PKG_FILENAME=$(basename "$PKG_FILE")
          PKG_NAME=$(basename -s .pkg.tar.zst "$PKG_FILENAME" | sed -E 's/^(.*)-[0-9].*$/\1/')
          
          # 1. Move the new package and its signature directly to the raveos-repo root
          mv "$PKG_FILE" ${{ env.REPO_NAME }}/
          mv "$PKG_FILE.sig" ${{ env.REPO_NAME }}/"$PKG_FILENAME.sig"

          # 2. Update and sign the repository database
          repo-add -s -k "$GPG_KEY_ID" ${{ env.REPO_NAME }}/${{ env.REPO_NAME }}.db.tar.gz ${{ env.REPO_NAME }}/"$PKG_FILENAME"

          # 3. Clean up older package versions
          cd ${{ env.REPO_NAME }}
          
          VERSIONS_TO_SKIP=$(( ${{ env.MAX_PKG_VERSIONS }} + 1 ))
          
          FILES_TO_DELETE=$(
            find . -maxdepth 1 -type f -name "${PKG_NAME}-*.pkg.tar.zst" \
            | sort -Vr \
            | tail -n +$VERSIONS_TO_SKIP
          )
          
          if [ -n "$FILES_TO_DELETE" ]; then
            echo "Deleting old package versions:"
            echo "$FILES_TO_DELETE"
            
            for file in $FILES_TO_DELETE; do
              rm -f "$file"
              rm -f "$file.sig"
            done
            
            repo-add -s -k "$GPG_KEY_ID" ${{ env.REPO_NAME }}.db.tar.gz *.pkg.tar.zst
          else
            echo "No old package versions to delete for $PKG_NAME. Keeping ${{ env.MAX_PKG_VERSIONS }}."
          fi
          
      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Build: Update ${{ matrix.package_name }} and repository database (RaveOS Repo)"
          branch: main
          file_pattern: '${{ env.REPO_NAME }}/**'
